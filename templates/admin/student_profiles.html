<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Profiles - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #f8f9fa; }
        .main-content { margin-top: 80px; padding: 20px 0; }
        .profiles-card { 
            background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            padding: 30px; margin-bottom: 20px; 
        }
        .student-card {
            background: white; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            padding: 20px; margin-bottom: 15px; transition: transform 0.3s ease;
            border-left: 4px solid #667eea;
        }
        .student-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .student-avatar {
            width: 60px; height: 60px; border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; font-size: 1.5rem;
        }
        .student-info h5 { margin-bottom: 5px; color: #333; }
        .student-info p { color: #6c757d; margin-bottom: 3px; font-size: 0.9rem; }
        .score-badge {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white; padding: 5px 12px; border-radius: 15px;
            font-size: 0.85rem; font-weight: 600;
        }
        .placement-badge {
            padding: 5px 12px; border-radius: 15px; font-size: 0.85rem; font-weight: 600;
        }
        .placement-high { background: #d4edda; color: #155724; }
        .placement-medium { background: #fff3cd; color: #856404; }
        .placement-low { background: #f8d7da; color: #721c24; }
        .placement-none { background: #e2e3e5; color: #6c757d; }
        .filter-controls {
            background: #f8f9fa; padding: 20px; border-radius: 10px;
            margin-bottom: 20px; border: 1px solid #e9ecef;
        }
        .search-box {
            border-radius: 25px; border: 2px solid #667eea;
            padding: 10px 20px;
        }
        .search-box:focus {
            border-color: #5a6fd8; box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .btn-view {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none; color: white; padding: 8px 20px;
            border-radius: 20px; font-weight: 600; font-size: 0.85rem;
        }
        .btn-view:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            color: white;
        }
        .stats-overview {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border-radius: 15px; padding: 25px; margin-bottom: 20px;
        }
        .sort-controls button {
            background: white; border: 1px solid #e9ecef; color: #6c757d;
            padding: 8px 15px; border-radius: 20px; margin: 0 5px;
            transition: all 0.3s ease;
        }
        .sort-controls button.active,
        .sort-controls button:hover {
            background: #667eea; color: white; border-color: #667eea;
        }
        @media (max-width: 768px) {
            .student-card { padding: 15px; }
            .filter-controls { padding: 15px; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('admin_dashboard') }}">
                <i class="fas fa-graduation-cap"></i> Admin Panel
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('admin_dashboard') }}">Dashboard</a>
                <a class="nav-link" href="{{ url_for('system_analytics') }}">Analytics</a>
                <a class="nav-link" href="{{ url_for('train_models') }}">Model Training</a>
                <a class="nav-link active" href="{{ url_for('student_profiles') }}">Student Profiles</a>
                <a class="nav-link" href="{{ url_for('auth.logout') }}">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container main-content">
        <!-- Header Stats -->
        <div class="stats-overview">
            <div class="row">
                <div class="col-md-8">
                    <h2><i class="fas fa-users"></i> Student Profiles Management</h2>
                    <p class="mb-0">Comprehensive overview of all registered students and their academic progress</p>
                </div>
                <div class="col-md-4 text-end">
                    <h3 class="mb-0">{{ students|length }}</h3>
                    <p class="mb-0">Total Students</p>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="profiles-card text-center">
                    <h4 class="text-primary" id="activeStudents">{{ students|length }}</h4>
                    <p class="text-muted mb-0">Active Students</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="profiles-card text-center">
                    <h4 class="text-success" id="highPerformers">0</h4>
                    <p class="text-muted mb-0">High Performers</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="profiles-card text-center">
                    <h4 class="text-warning" id="avgAssessments">0</h4>
                    <p class="text-muted mb-0">Avg Assessments</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="profiles-card text-center">
                    <h4 class="text-info" id="placementReady">0</h4>
                    <p class="text-muted mb-0">Placement Ready</p>
                </div>
            </div>
        </div>

        <!-- Filter and Search Controls -->
        <div class="filter-controls">
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Search Students</label>
                    <input type="text" class="form-control search-box" id="searchInput" 
                           placeholder="Search by name, email, or branch...">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Branch Filter</label>
                    <select class="form-select" id="branchFilter">
                        <option value="">All Branches</option>
                        <option value="CSE">Computer Science</option>
                        <option value="IT">Information Technology</option>
                        <option value="ECE">Electronics & Communication</option>
                        <option value="EEE">Electrical Engineering</option>
                        <option value="MECH">Mechanical Engineering</option>
                        <option value="CIVIL">Civil Engineering</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Year Filter</label>
                    <select class="form-select" id="yearFilter">
                        <option value="">All Years</option>
                        <option value="1">First Year</option>
                        <option value="2">Second Year</option>
                        <option value="3">Third Year</option>
                        <option value="4">Final Year</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Sort By</label>
                    <div class="sort-controls">
                        <button class="active" onclick="sortStudents('name')">Name</button>
                        <button onclick="sortStudents('cgpa')">CGPA</button>
                        <button onclick="sortStudents('assessments')">Assessments</button>
                        <button onclick="sortStudents('placement')">Placement Score</button>
                        <button onclick="sortStudents('recent')">Recent</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Students List -->
        <div class="profiles-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5><i class="fas fa-list"></i> Student Profiles <span id="studentCount">({{ students|length }})</span></h5>
                <div>
                    <button class="btn btn-outline-primary" onclick="exportStudentData()">
                        <i class="fas fa-download"></i> Export Data
                    </button>
                    <button class="btn btn-primary" onclick="refreshData()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
            </div>

            <div id="studentsList">
                {% if students and students|length > 0 %}
                    {% for student in students %}
                    <div class="student-card" data-branch="{{ student.branch or '' }}" 
                         data-year="{{ student.academic_year or '' }}" 
                         data-name="{{ student.first_name }} {{ student.last_name }}"
                         data-email="{{ student.email }}"
                         data-cgpa="{{ student.cgpa or 0 }}"
                         data-assessments="{{ student.total_assessments or 0 }}"
                         data-placement="{{ (student.prediction_probability or 0) * 100 }}">
                        <div class="row align-items-center">
                            <div class="col-md-1">
                                <div class="student-avatar">
                                    {{ student.first_name[0] if student.first_name else 'U' }}{{ student.last_name[0] if student.last_name else 'S' }}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="student-info">
                                    <h5>{{ student.first_name or 'Unknown' }} {{ student.last_name or 'Student' }}</h5>
                                    <p><i class="fas fa-envelope"></i> {{ student.email or 'No email' }}</p>
                                    <p><i class="fas fa-graduation-cap"></i> {{ student.branch or 'Not specified' }} - Year {{ student.academic_year or 'N/A' }}</p>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <p class="text-muted mb-1">Academic Performance</p>
                                <div class="d-flex align-items-center">
                                    <strong class="me-2">CGPA: {{ "%.2f"|format(student.cgpa or 0) }}</strong>
                                    {% if student.avg_score and student.avg_score > 0 %}
                                        <span class="score-badge">{{ "%.1f"|format(student.avg_score) }}%</span>
                                    {% else %}
                                        <span class="text-muted">No assessments</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-2">
                                <p class="text-muted mb-1">Activity</p>
                                <p><i class="fas fa-tasks"></i> {{ student.total_assessments or 0 }} Assessments</p>
                                <p><i class="fas fa-code"></i> {{ student.num_projects or 0 }} Projects</p>
                            </div>
                            <div class="col-md-2">
                                <p class="text-muted mb-1">Placement Probability</p>
                                {% set prob = (student.prediction_probability or 0) * 100 %}
                                {% if prob >= 70 %}
                                    <span class="placement-badge placement-high">{{ "%.1f"|format(prob) }}% High</span>
                                {% elif prob >= 50 %}
                                    <span class="placement-badge placement-medium">{{ "%.1f"|format(prob) }}% Medium</span>
                                {% elif prob > 0 %}
                                    <span class="placement-badge placement-low">{{ "%.1f"|format(prob) }}% Low</span>
                                {% else %}
                                    <span class="placement-badge placement-none">Not Predicted</span>
                                {% endif %}
                            </div>
                            <div class="col-md-2 text-end">
                                <a href="{{ url_for('student_profile_detail', student_id=student.id) }}" 
                                   class="btn btn-view">
                                    <i class="fas fa-eye"></i> View Profile
                                </a>
                                <p class="text-muted mb-0 mt-2">
                                    <small>Joined: {{ student.created_at[:10] if student.created_at else 'Unknown' }}</small>
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-users fa-5x text-muted mb-4"></i>
                        <h4 class="text-muted">No Students Found</h4>
                        <p class="text-muted">No student profiles are available in the system yet.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allStudents = [];
        let currentSort = 'name';

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            allStudents = Array.from(document.querySelectorAll('.student-card'));
            calculateStats();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', filterStudents);
            document.getElementById('branchFilter').addEventListener('change', filterStudents);
            document.getElementById('yearFilter').addEventListener('change', filterStudents);
        }

        function calculateStats() {
            const students = allStudents;
            let highPerformers = 0;
            let totalAssessments = 0;
            let placementReady = 0;

            students.forEach(student => {
                const placement = parseFloat(student.dataset.placement);
                const assessments = parseInt(student.dataset.assessments);
                
                if (placement >= 70) {
                    highPerformers++;
                }
                if (placement >= 60) {
                    placementReady++;
                }
                totalAssessments += assessments;
            });

            document.getElementById('highPerformers').textContent = highPerformers;
            document.getElementById('avgAssessments').textContent = 
                students.length > 0 ? Math.round(totalAssessments / students.length) : 0;
            document.getElementById('placementReady').textContent = placementReady;
        }

        function filterStudents() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const branchFilter = document.getElementById('branchFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;

            let visibleCount = 0;

            allStudents.forEach(student => {
                const name = student.dataset.name.toLowerCase();
                const email = student.dataset.email.toLowerCase();
                const branch = student.dataset.branch;
                const year = student.dataset.year;

                const matchesSearch = name.includes(searchTerm) || 
                                    email.includes(searchTerm) || 
                                    branch.toLowerCase().includes(searchTerm);
                const matchesBranch = !branchFilter || branch === branchFilter;
                const matchesYear = !yearFilter || year === yearFilter;

                if (matchesSearch && matchesBranch && matchesYear) {
                    student.style.display = 'block';
                    visibleCount++;
                } else {
                    student.style.display = 'none';
                }
            });

            document.getElementById('studentCount').textContent = `(${visibleCount})`;
        }

        function sortStudents(sortBy) {
            // Update active button
            document.querySelectorAll('.sort-controls button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            const container = document.getElementById('studentsList');
            const students = Array.from(container.children);

            students.sort((a, b) => {
                switch(sortBy) {
                    case 'name':
                        return a.dataset.name.localeCompare(b.dataset.name);
                    case 'cgpa':
                        return parseFloat(b.dataset.cgpa) - parseFloat(a.dataset.cgpa);
                    case 'assessments':
                        return parseInt(b.dataset.assessments) - parseInt(a.dataset.assessments);
                    case 'placement':
                        return parseFloat(b.dataset.placement) - parseFloat(a.dataset.placement);
                    case 'recent':
                        return new Date(b.querySelector('small').textContent.split(': ')[1]) - 
                               new Date(a.querySelector('small').textContent.split(': ')[1]);
                    default:
                        return 0;
                }
            });

            // Re-append sorted elements
            students.forEach(student => container.appendChild(student));
            currentSort = sortBy;
        }

        function exportStudentData() {
            alert('Exporting student data to Excel... (Feature will be implemented)');
        }

        function refreshData() {
            location.reload();
        }
    </script>
</body>
</html>