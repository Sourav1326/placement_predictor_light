<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ profile.get('first_name', 'Student') }} {{ profile.get('last_name', '') }} - Profile Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #f8f9fa; }
        .main-content { margin-top: 80px; padding: 20px 0; }
        .profile-card { 
            background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            padding: 30px; margin-bottom: 20px; 
        }
        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border-radius: 15px; padding: 30px; margin-bottom: 20px;
        }
        .student-avatar {
            width: 100px; height: 100px; border-radius: 50%;
            background: rgba(255,255,255,0.2); display: flex; align-items: center; 
            justify-content: center; color: white; font-weight: bold; font-size: 2.5rem;
            border: 4px solid rgba(255,255,255,0.3);
        }
        .info-section {
            background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 15px 0;
        }
        .metric-card {
            background: white; border-radius: 10px; padding: 20px; text-align: center;
            border-left: 4px solid #667eea; margin-bottom: 15px;
        }
        .metric-value {
            font-size: 2rem; font-weight: bold; color: #667eea; margin-bottom: 5px;
        }
        .assessment-item {
            background: white; border-radius: 8px; padding: 15px; margin: 10px 0;
            border-left: 4px solid #28a745; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .skill-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white; padding: 8px 16px; border-radius: 20px; margin: 5px;
            display: inline-block; font-size: 0.9rem; font-weight: 600;
        }
        .chart-container {
            background: white; padding: 20px; border-radius: 10px;
            height: 300px; position: relative;
        }
        .chart-wrapper {
            position: relative; height: 220px; width: 100%;
        }
        .status-badge {
            padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.85rem;
        }
        .status-excellent { background: #d4edda; color: #155724; }
        .status-good { background: #cce7ff; color: #004085; }
        .status-average { background: #fff3cd; color: #856404; }
        .status-poor { background: #f8d7da; color: #721c24; }
        .prediction-card {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white; border-radius: 15px; padding: 25px; text-align: center;
        }
        .btn-action {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none; color: white; padding: 10px 25px;
            border-radius: 20px; font-weight: 600; margin: 5px;
        }
        .btn-action:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            color: white;
        }
        @media (max-width: 768px) {
            .profile-card { padding: 20px; }
            .chart-container { height: 250px; }
            .chart-wrapper { height: 170px; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('admin_dashboard') }}">
                <i class="fas fa-graduation-cap"></i> Admin Panel
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('admin_dashboard') }}">Dashboard</a>
                <a class="nav-link" href="{{ url_for('student_profiles') }}">
                    <i class="fas fa-arrow-left"></i> Back to Profiles
                </a>
                <a class="nav-link" href="{{ url_for('auth.logout') }}">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container main-content">
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="row align-items-center">
                <div class="col-md-2">
                    <div class="student-avatar">
                        {{ profile.get('first_name', 'N')[0] }}{{ profile.get('last_name', 'A')[0] }}
                    </div>
                </div>
                <div class="col-md-6">
                    <h2>{{ profile.get('first_name', 'Unknown') }} {{ profile.get('last_name', 'Student') }}</h2>
                    <p class="mb-1"><i class="fas fa-envelope"></i> {{ profile.get('email', 'No email') }}</p>
                    <p class="mb-1"><i class="fas fa-graduation-cap"></i> {{ profile.get('branch', 'Not specified') }} - Year {{ profile.get('academic_year', 'N/A') }}</p>
                    <p class="mb-0"><i class="fas fa-calendar"></i> Joined: {{ profile.get('created_at', '')[:10] if profile.get('created_at') else 'Unknown' }}</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="prediction-card">
                        <h3>{{ "%.1f"|format((predictions[0].prediction_probability * 100) if predictions and predictions[0].prediction_probability else 0) }}%</h3>
                        <p class="mb-0">Placement Probability</p>
                        <small>Last updated: {{ predictions[0].prediction_date[:10] if predictions and predictions[0].prediction_date else 'Never' }}</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="profile-card">
            <h5><i class="fas fa-tools"></i> Quick Actions</h5>
            <div class="text-center">
                <button class="btn btn-action" onclick="sendMessage()">
                    <i class="fas fa-envelope"></i> Send Message
                </button>
                <button class="btn btn-action" onclick="scheduleInterview()">
                    <i class="fas fa-calendar-plus"></i> Schedule Interview
                </button>
                <button class="btn btn-action" onclick="generateReport()">
                    <i class="fas fa-file-pdf"></i> Generate Report
                </button>
                <button class="btn btn-action" onclick="updateProfile()">
                    <i class="fas fa-edit"></i> Update Profile
                </button>
            </div>
        </div>

        <!-- Academic Information -->
        <div class="row">
            <div class="col-md-6">
                <div class="profile-card">
                    <h5><i class="fas fa-school"></i> Academic Information</h5>
                    <div class="info-section">
                        <div class="row">
                            <div class="col-6">
                                <p><strong>CGPA:</strong> {{ "%.2f"|format(profile.get('cgpa', 0)) or 'Not provided' }}</p>
                                <p><strong>10th Percentage:</strong> {{ "%.1f"|format(profile.get('tenth_percentage', 0)) or 'Not provided' }}%</p>
                                <p><strong>12th Percentage:</strong> {{ "%.1f"|format(profile.get('twelfth_percentage', 0)) or 'Not provided' }}%</p>
                            </div>
                            <div class="col-6">
                                <p><strong>Projects:</strong> {{ profile.get('num_projects', 0) }}</p>
                                <p><strong>Internships:</strong> {{ profile.get('num_internships', 0) }}</p>
                                <p><strong>Certifications:</strong> {{ profile.get('num_certifications', 0) }}</p>
                            </div>
                        </div>
                        
                        {% if profile.get('programming_languages') %}
                        <div class="mt-3">
                            <p><strong>Programming Languages:</strong></p>
                            {% set languages = profile.programming_languages.split(',') if profile.programming_languages else [] %}
                            {% for lang in languages %}
                                <span class="skill-badge">{{ lang.strip() }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="profile-card">
                    <h5><i class="fas fa-trophy"></i> Performance Metrics</h5>
                    <div class="row">
                        <div class="col-6">
                            <div class="metric-card">
                                <div class="metric-value">{{ analytics.get('assessments', {}).get('total_assessments', 0) }}</div>
                                <p class="text-muted mb-0">Total Assessments</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="metric-card">
                                <div class="metric-value">{{ "%.1f"|format(analytics.get('assessments', {}).get('average_score', 0)) }}%</div>
                                <p class="text-muted mb-0">Average Score</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="metric-card">
                                <div class="metric-value">{{ profile.get('leetcode_score', 0) }}</div>
                                <p class="text-muted mb-0">LeetCode Score</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="metric-card">
                                <div class="metric-value">{{ profile.get('codechef_rating', 0) }}</div>
                                <p class="text-muted mb-0">CodeChef Rating</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts and Analytics -->
        <div class="row">
            <div class="col-md-8">
                <div class="profile-card">
                    <h5><i class="fas fa-chart-line"></i> Performance Timeline</h5>
                    <div class="chart-container">
                        <div class="chart-wrapper">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="profile-card">
                    <h5><i class="fas fa-chart-pie"></i> Skill Distribution</h5>
                    <div class="chart-container">
                        <div class="chart-wrapper">
                            <canvas id="skillChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assessment History -->
        <div class="profile-card">
            <h5><i class="fas fa-history"></i> Assessment History</h5>
            {% if assessments %}
                {% for assessment in assessments[:10] %}
                <div class="assessment-item">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <h6 class="mb-1">{{ assessment.assessment_type.replace('_', ' ').title() }}</h6>
                            <small class="text-muted">{{ assessment.assessment_date[:10] if assessment.assessment_date else 'Unknown date' }}</small>
                        </div>
                        <div class="col-md-2">
                            {% if assessment.language %}
                            <span class="skill-badge">{{ assessment.language }}</span>
                            {% endif %}
                        </div>
                        <div class="col-md-2">
                            <strong>{{ assessment.score or 0 }}/{{ assessment.total_questions or 0 }}</strong>
                        </div>
                        <div class="col-md-2">
                            {% set percentage = assessment.percentage or 0 %}
                            {% if percentage >= 80 %}
                                <span class="status-badge status-excellent">{{ "%.1f"|format(percentage) }}%</span>
                            {% elif percentage >= 60 %}
                                <span class="status-badge status-good">{{ "%.1f"|format(percentage) }}%</span>
                            {% elif percentage >= 40 %}
                                <span class="status-badge status-average">{{ "%.1f"|format(percentage) }}%</span>
                            {% else %}
                                <span class="status-badge status-poor">{{ "%.1f"|format(percentage) }}%</span>
                            {% endif %}
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">
                                Time: {{ (assessment.time_taken // 60) if assessment.time_taken else 0 }} min {{ (assessment.time_taken % 60) if assessment.time_taken else 0 }} sec
                            </small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Assessments Taken</h5>
                    <p class="text-muted">This student hasn't completed any assessments yet.</p>
                </div>
            {% endif %}
        </div>

        <!-- Placement Predictions History -->
        <div class="profile-card">
            <h5><i class="fas fa-crystal-ball"></i> Placement Prediction History</h5>
            {% if predictions %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Probability</th>
                                <th>Model Used</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for prediction in predictions[:5] %}
                            <tr>
                                <td>{{ prediction.prediction_date[:10] if prediction.prediction_date else 'Unknown' }}</td>
                                <td>
                                    {% set prob = (prediction.prediction_probability or 0) * 100 %}
                                    {% if prob >= 70 %}
                                        <span class="status-badge status-excellent">{{ "%.1f"|format(prob) }}%</span>
                                    {% elif prob >= 50 %}
                                        <span class="status-badge status-good">{{ "%.1f"|format(prob) }}%</span>
                                    {% elif prob >= 30 %}
                                        <span class="status-badge status-average">{{ "%.1f"|format(prob) }}%</span>
                                    {% else %}
                                        <span class="status-badge status-poor">{{ "%.1f"|format(prob) }}%</span>
                                    {% endif %}
                                </td>
                                <td>{{ prediction.model_used or 'Unknown' }}</td>
                                <td>
                                    {% if loop.index < predictions|length %}
                                        {% set prev_prob = predictions[loop.index].prediction_probability or 0 %}
                                        {% set curr_prob = prediction.prediction_probability or 0 %}
                                        {% if curr_prob > prev_prob %}
                                            <i class="fas fa-arrow-up text-success"></i> Improving
                                        {% elif curr_prob < prev_prob %}
                                            <i class="fas fa-arrow-down text-danger"></i> Declining
                                        {% else %}
                                            <i class="fas fa-minus text-warning"></i> Stable
                                        {% endif %}
                                    {% else %}
                                        <i class="fas fa-minus text-muted"></i> N/A
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-crystal-ball fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Placement Predictions</h5>
                    <p class="text-muted">No placement predictions have been generated for this student yet.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Performance Timeline Chart
        const performanceCtx = document.getElementById('performanceChart').getContext('2d');
        const assessmentHistory = {{ assessments | tojson | safe }};
        
        // Process assessment data for timeline
        const timelineData = assessmentHistory.slice(0, 10).reverse().map(assessment => ({
            x: assessment.assessment_date ? assessment.assessment_date.substring(0, 10) : '',
            y: assessment.percentage || 0
        }));

        new Chart(performanceCtx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Assessment Scores',
                    data: timelineData,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2.5,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        // Skill Distribution Chart
        const skillCtx = document.getElementById('skillChart').getContext('2d');
        const skillDistribution = {{ analytics.get('assessments', {}).get('skill_distribution', {}) | tojson | safe }};
        
        const skillLabels = Object.keys(skillDistribution);
        const skillAverages = skillLabels.map(skill => {
            const scores = skillDistribution[skill];
            return scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
        });

        new Chart(skillCtx, {
            type: 'doughnut',
            data: {
                labels: skillLabels,
                datasets: [{
                    data: skillAverages,
                    backgroundColor: [
                        '#667eea', '#764ba2', '#f093fb', '#f5576c', 
                        '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1.5,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            usePointStyle: true
                        }
                    }
                }
            }
        });

        // Action functions
        function sendMessage() {
            alert('Send message feature will be implemented');
        }

        function scheduleInterview() {
            alert('Schedule interview feature will be implemented');
        }

        function generateReport() {
            alert('Generate report feature will be implemented');
        }

        function updateProfile() {
            alert('Update profile feature will be implemented');
        }
    </script>
</body>
</html>