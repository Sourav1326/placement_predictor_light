<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Training - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #f8f9fa; }
        .main-content { margin-top: 80px; padding: 20px 0; }
        .training-card { 
            background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            padding: 30px; margin-bottom: 20px; 
        }
        .model-type-card { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; padding: 25px; border-radius: 15px; text-align: center;
            margin-bottom: 20px; cursor: pointer; transition: transform 0.3s ease;
        }
        .model-type-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .model-type-card.selected {
            background: linear-gradient(135deg, #28a745 0%, #20a039 100%);
            transform: translateY(-3px);
        }
        .training-status {
            background: #f8f9fa; border-radius: 10px; padding: 20px;
            border-left: 4px solid #667eea; margin: 20px 0;
        }
        .metrics-card {
            background: white; border-radius: 10px; padding: 20px;
            border: 1px solid #e9ecef; margin: 10px 0;
        }
        .btn-train {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none; color: white; padding: 12px 30px;
            border-radius: 25px; font-weight: 600;
        }
        .btn-train:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            color: white;
        }
        .btn-train:disabled {
            background: #6c757d; cursor: not-allowed;
        }
        .progress-container {
            display: none; margin: 20px 0;
        }
        .log-container {
            background: #1e1e1e; color: #00ff00; padding: 20px;
            border-radius: 10px; font-family: 'Courier New', monospace;
            height: 300px; overflow-y: auto; margin: 20px 0;
            display: none;
        }
        .status-indicator {
            display: inline-block; width: 12px; height: 12px;
            border-radius: 50%; margin-right: 10px;
        }
        .status-ready { background: #28a745; }
        .status-training { background: #ffc107; animation: pulse 1.5s infinite; }
        .status-error { background: #dc3545; }
        .status-complete { background: #17a2b8; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .training-card { padding: 20px; }
            .model-type-card { margin-bottom: 15px; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('admin_dashboard') }}">
                <i class="fas fa-graduation-cap"></i> Admin Panel
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('admin_dashboard') }}">Dashboard</a>
                <a class="nav-link" href="{{ url_for('system_analytics') }}">Analytics</a>
                <a class="nav-link active" href="{{ url_for('train_models') }}">Model Training</a>
                <a class="nav-link" href="{{ url_for('auth.logout') }}">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container main-content">
        <!-- Header -->
        <div class="training-card">
            <h2><i class="fas fa-brain"></i> Machine Learning Model Training</h2>
            <p class="text-muted">Train and manage placement prediction models for optimal student assessment accuracy</p>
            
            <!-- Current Model Status -->
            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="text-center">
                        <span class="status-indicator status-ready"></span>
                        <strong>Traditional Models</strong>
                        <p class="text-muted mb-0" id="traditionalStatus">Ready for training</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <span class="status-indicator status-ready"></span>
                        <strong>Deep Learning</strong>
                        <p class="text-muted mb-0" id="deepStatus">Ready for training</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <span class="status-indicator status-complete"></span>
                        <strong>Data Pipeline</strong>
                        <p class="text-muted mb-0">Operational</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <span class="status-indicator status-complete"></span>
                        <strong>API Service</strong>
                        <p class="text-muted mb-0">Running</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Model Selection -->
        <div class="row">
            <div class="col-md-6">
                <div class="model-type-card" id="traditionalCard" onclick="selectModelType('traditional')">
                    <i class="fas fa-chart-line fa-3x mb-3"></i>
                    <h4>Traditional ML Models</h4>
                    <p class="mb-0">Random Forest, Gradient Boosting, Logistic Regression</p>
                    <small>Faster training â€¢ Interpretable results â€¢ Production ready</small>
                </div>
            </div>
            <div class="col-md-6">
                <div class="model-type-card" id="deepCard" onclick="selectModelType('deep_learning')">
                    <i class="fas fa-brain fa-3x mb-3"></i>
                    <h4>Deep Learning Model</h4>
                    <p class="mb-0">Neural Network with advanced feature learning</p>
                    <small>Higher accuracy â€¢ Complex patterns â€¢ Longer training</small>
                </div>
            </div>
        </div>

        <!-- Training Configuration -->
        <div class="training-card">
            <h5><i class="fas fa-cogs"></i> Training Configuration</h5>
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Selected Model Type</label>
                    <input type="text" class="form-control" id="selectedModelDisplay" value="Select a model type" readonly>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Training Data Status</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="dataStatus" value="Checking..." readonly>
                        <button class="btn btn-outline-secondary" onclick="checkDataStatus()">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Estimated Training Time</label>
                    <input type="text" class="form-control" id="estimatedTime" value="Select model first" readonly>
                </div>
            </div>
            
            <!-- Training Controls -->
            <div class="text-center mt-4">
                <button class="btn btn-train" id="trainButton" onclick="startTraining()" disabled>
                    <i class="fas fa-play"></i> Start Training
                </button>
                <button class="btn btn-outline-secondary ms-2" onclick="resetConfiguration()">
                    <i class="fas fa-undo"></i> Reset
                </button>
            </div>
        </div>

        <!-- Training Progress -->
        <div class="progress-container" id="progressContainer">
            <div class="training-card">
                <h5><i class="fas fa-spinner fa-spin"></i> Training in Progress</h5>
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         id="trainingProgress" role="progressbar" style="width: 0%"></div>
                </div>
                <div class="training-status" id="trainingStatus">
                    <strong>Status:</strong> <span id="currentStatus">Initializing...</span>
                </div>
            </div>
        </div>

        <!-- Training Logs -->
        <div class="log-container" id="logContainer">
            <div id="trainingLogs">Training logs will appear here...</div>
        </div>

        <!-- Training Results -->
        <div class="training-card" id="resultsContainer" style="display: none;">
            <h5><i class="fas fa-chart-bar"></i> Training Results</h5>
            <div class="row" id="metricsContainer">
                <!-- Metrics will be populated here -->
            </div>
            
            <div class="alert alert-success mt-3" id="successMessage" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <strong>Training Completed Successfully!</strong>
                <span id="successDetails"></span>
            </div>
            
            <div class="alert alert-danger mt-3" id="errorMessage" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Training Failed!</strong>
                <span id="errorDetails"></span>
            </div>
        </div>

        <!-- Previous Training History -->
        <div class="training-card">
            <h5><i class="fas fa-history"></i> Training History</h5>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Model Type</th>
                            <th>Status</th>
                            <th>Accuracy</th>
                            <th>Training Time</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr>
                            <td colspan="6" class="text-center text-muted">No training history available</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedModelType = null;
        let trainingInProgress = false;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkDataStatus();
        });

        function selectModelType(modelType) {
            selectedModelType = modelType;
            
            // Update UI
            document.querySelectorAll('.model-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            if (modelType === 'traditional') {
                document.getElementById('traditionalCard').classList.add('selected');
                document.getElementById('selectedModelDisplay').value = 'Traditional ML Models';
                document.getElementById('estimatedTime').value = '2-5 minutes';
            } else {
                document.getElementById('deepCard').classList.add('selected');
                document.getElementById('selectedModelDisplay').value = 'Deep Learning Model';
                document.getElementById('estimatedTime').value = '10-20 minutes';
            }
            
            // Enable training button if data is ready
            const dataReady = document.getElementById('dataStatus').value.includes('Ready');
            document.getElementById('trainButton').disabled = !dataReady;
        }

        function checkDataStatus() {
            // Simulate data check - in real implementation, this would be an API call
            setTimeout(() => {
                document.getElementById('dataStatus').value = 'Ready (1,245 records)';
                if (selectedModelType) {
                    document.getElementById('trainButton').disabled = false;
                }
            }, 1000);
        }

        function startTraining() {
            if (!selectedModelType || trainingInProgress) return;
            
            trainingInProgress = true;
            document.getElementById('trainButton').disabled = true;
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('logContainer').style.display = 'block';
            document.getElementById('resultsContainer').style.display = 'none';
            
            // Update status indicators
            const statusElement = selectedModelType === 'traditional' ? 
                document.getElementById('traditionalStatus') : 
                document.getElementById('deepStatus');
            statusElement.textContent = 'Training in progress...';
            statusElement.previousElementSibling.className = 'status-indicator status-training';
            
            // Start training API call
            fetch('/trigger-training', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model_type: selectedModelType
                })
            })
            .then(response => response.json())
            .then(data => {
                handleTrainingResponse(data);
            })
            .catch(error => {
                handleTrainingError(error);
            });
            
            // Simulate training progress
            simulateTrainingProgress();
        }

        function simulateTrainingProgress() {
            let progress = 0;
            const maxProgress = selectedModelType === 'traditional' ? 100 : 100;
            const increment = selectedModelType === 'traditional' ? 5 : 2;
            const interval = selectedModelType === 'traditional' ? 1000 : 2000;
            
            const progressInterval = setInterval(() => {
                progress += increment;
                document.getElementById('trainingProgress').style.width = progress + '%';
                
                // Update status messages
                if (progress < 30) {
                    document.getElementById('currentStatus').textContent = 'Loading training data...';
                    addLogMessage('ðŸ“Š Loading and preprocessing training data...');
                } else if (progress < 60) {
                    document.getElementById('currentStatus').textContent = 'Training model...';
                    addLogMessage('ðŸ¤– Training ' + selectedModelType + ' model...');
                } else if (progress < 90) {
                    document.getElementById('currentStatus').textContent = 'Validating model...';
                    addLogMessage('âœ… Validating model performance...');
                } else if (progress >= 100) {
                    document.getElementById('currentStatus').textContent = 'Finalizing...';
                    addLogMessage('ðŸ’¾ Saving trained model...');
                    clearInterval(progressInterval);
                }
            }, interval);
        }

        function handleTrainingResponse(data) {
            trainingInProgress = false;
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'block';
            
            if (data.success) {
                // Show success message
                document.getElementById('successMessage').style.display = 'block';
                document.getElementById('errorMessage').style.display = 'none';
                document.getElementById('successDetails').textContent = data.message;
                
                // Update status indicators
                const statusElement = selectedModelType === 'traditional' ? 
                    document.getElementById('traditionalStatus') : 
                    document.getElementById('deepStatus');
                statusElement.textContent = 'Training completed';
                statusElement.previousElementSibling.className = 'status-indicator status-complete';
                
                // Display metrics
                displayTrainingMetrics(data.metrics);
                addLogMessage('ðŸŽ‰ Training completed successfully!');
                
            } else {
                // Show error message
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('successMessage').style.display = 'none';
                document.getElementById('errorDetails').textContent = data.message;
                
                // Update status indicators
                const statusElement = selectedModelType === 'traditional' ? 
                    document.getElementById('traditionalStatus') : 
                    document.getElementById('deepStatus');
                statusElement.textContent = 'Training failed';
                statusElement.previousElementSibling.className = 'status-indicator status-error';
                
                addLogMessage('âŒ Training failed: ' + data.message);
            }
            
            // Re-enable training button
            document.getElementById('trainButton').disabled = false;
        }

        function handleTrainingError(error) {
            trainingInProgress = false;
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('errorDetails').textContent = 'Network error: ' + error.message;
            
            addLogMessage('âŒ Training error: ' + error.message);
            document.getElementById('trainButton').disabled = false;
        }

        function displayTrainingMetrics(metrics) {
            const container = document.getElementById('metricsContainer');
            container.innerHTML = '';
            
            if (metrics) {
                Object.entries(metrics).forEach(([key, value]) => {
                    const metricCard = document.createElement('div');
                    metricCard.className = 'col-md-3';
                    metricCard.innerHTML = `
                        <div class="metrics-card text-center">
                            <h4 class="text-primary">${(value * 100).toFixed(1)}%</h4>
                            <p class="mb-0">${key.replace(/_/g, ' ').toUpperCase()}</p>
                        </div>
                    `;
                    container.appendChild(metricCard);
                });
            }
        }

        function addLogMessage(message) {
            const logContainer = document.getElementById('trainingLogs');
            const timestamp = new Date().toLocaleTimeString();
            logContainer.innerHTML += `[${timestamp}] ${message}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function resetConfiguration() {
            selectedModelType = null;
            document.querySelectorAll('.model-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('selectedModelDisplay').value = 'Select a model type';
            document.getElementById('estimatedTime').value = 'Select model first';
            document.getElementById('trainButton').disabled = true;
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('logContainer').style.display = 'none';
        }
    </script>
</body>
</html>